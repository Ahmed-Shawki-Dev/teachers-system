datasource db {
  provider = "mongodb"
  url = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. Enums
enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
}

enum PaymentType {
  PER_SESSION
  MONTHLY
}

// 2. Models
model Teacher {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String   @unique
  password  String
  avatarUrl String?
  phone     String?
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students Student[]
  groups   Group[]
}

model ClassSchedule {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  dayOfWeek DayOfWeek
  startTime String
  endTime   String

  groupId String @db.ObjectId
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, dayOfWeek, startTime])
}

model Enrollment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  studentId String @db.ObjectId
  groupId   String @db.ObjectId

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, groupId])
  @@index([groupId])
  @@index([studentId])
}

model Student {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  studentCode String @unique
  name        String

  parentPhone String   
  createdAt   DateTime? @default(now()) 
  updatedAt   DateTime? @updatedAt

  teacherId String  @db.ObjectId
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  enrollments Enrollment[]
  attendances Attendance[] 
  payments Payment[]
  examResults ExamResult[]

  @@unique([name, parentPhone, teacherId])
}

model Group {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  name      String   
  price     Float    @default(0)
  paymentType PaymentType @default(PER_SESSION)
  createdAt   DateTime? @default(now()) 
  updatedAt   DateTime? @updatedAt

  teacherId String  @db.ObjectId
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  enrollments Enrollment[]
  schedule    ClassSchedule[]
  sessions    Session[]
  payments    Payment[]
  exams Exam[]


  @@unique([name, teacherId])
}

model Session {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  sessionDate DateTime
  status      SessionStatus @default(SCHEDULED)
  note        String?

  groupId String @db.ObjectId
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  payments Payment[]
  attendances Attendance[]
  @@index([groupId])
}


model Attendance {
  id     String           @id @default(auto()) @map("_id") @db.ObjectId
  status AttendanceStatus @default(ABSENT)
  note   String?

  sessionId String  @db.ObjectId
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
}


model Payment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float   
  date      DateTime @default(now())
  
  studentId String   @db.ObjectId
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)


  groupId   String   @db.ObjectId
  group     Group    @relation(fields: [groupId], references: [id])


  sessionId String?  @db.ObjectId 
  session   Session? @relation(fields: [sessionId], references: [id])

  monthKey  String?  

  type      PaymentType 
  note      String?

  createdAt DateTime @default(now())
}


model Exam{
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  date       DateTime   @default(now())
  maxScore   Float

  groupId    String     @db.ObjectId
  group      Group      @relation(fields: [groupId],references: [id], onDelete: Cascade)

  results   ExamResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([groupId])
}


model ExamResult{
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  score     Float

  examId    String   @db.ObjectId
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String   @db.ObjectId
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examId, studentId])
  @@index([studentId])
}